## åˆ†äº«å‰å•°å—¦

æˆ‘ä¹‹å‰ä»‹ç»è¿‡vue1.0å¦‚ä½•å®ç°`observer`å’Œ`watcher`ã€‚æœ¬æƒ³ç»§ç»­å†™ä¸‹å»ï¼Œå¯æ˜¯vue2.0æ¨ªç©ºå‡ºä¸–..æ‰€ä»¥
ç›´æ¥çœ‹vue2.0å§ã€‚è¿™ç¯‡æ–‡ç« åœ¨å…¬å¸åˆ†äº«è¿‡ï¼Œç»ˆäºå¯ä»¥å€ŸåŠ©åæœˆä¸€çš„æœºä¼šå†™å†™æˆæ–‡ç« ã€‚
ä»¥å‰å†™çš„é‚£ç¯‡ [vue æºç åˆ†æä¹‹å¦‚ä½•å®ç° observer å’Œ watcher][1]æœ€å¥½åœ¨çœ‹æœ¬æ¬¡åˆ†äº«ä¹‹å‰å»çœ‹çœ‹ï¼Œä¸è¿‡ä¸çœ‹ä¹Ÿæ²¡å…³ç³»ï¼Œä½†æ˜¯å¿…é¡»å¾—äº†è§£[Object.defineProperty][2]

## æœ¬æ–‡åˆ†äº«ä»€ä¹ˆ
ç†è§£vue2.0çš„å“åº”å¼æ¶æ„ï¼Œå°±æ˜¯ä¸‹é¢è¿™å¼ å›¾
![vuedeptrace.jpg][3]


é¡ºå¸¦ä»‹ç»ä»–æ¯”reactå¿«çš„å…¶ä¸­ä¸€ä¸ªåŸå› 


## æœ¬åˆ†å®ç°ä»€ä¹ˆ
```javascript
const demo = new Vue({
  data: {
    text: "before",
  },
  //å¯¹åº”çš„template ä¸º <div><span>{{text}}</span></div>
  render(h){
    return h('div', {}, [
      h('span', {}, [this.__toString__(this.text)])
    ])
  }
})
 setTimeout(function(){
   demo.text = "after"
 }, 3000)
```
å¯¹åº”çš„è™šæ‹Ÿdomä¼šä»
`<div><span>before</span></div>` å˜ä¸º `<div><span>after</span></div>`
å¥½ï¼Œå¼€å§‹å§ï¼ï¼ï¼
## ç¬¬ä¸€æ­¥ï¼Œ è®²data ä¸‹é¢æ‰€æœ‰å±æ€§å˜ä¸ºobservable
æ¥æ¥æ¥å…ˆçœ‹ä»£ç å§
```javascript
    class Vue {
      constructor(options) {
        this.$options = options
        this._data = options.data
        observer(options.data, this._update)
        this._update()
      }
      _update(){
        this.$options.render()
      }
    }


    function observer(value, cb){
      Object.keys(value).forEach((key) => defineReactive(value, key, value[key] , cb))
    }

    function defineReactive(obj, key, val, cb) {
      Object.defineProperty(obj, key, {
        enumerable: true,
        configurable: true,
        get: ()=>{},
        set:newVal=> {
          cb()
        }
      })
    }

    var demo = new Vue({
      el: '#demo',
      data: {
        text: 123,
      },
      render(){
        console.log("æˆ‘è¦renderäº†")
      }
    })

     setTimeout(function(){
       demo._data.text = 444
     }, 3000)
```

 ä¸ºäº†å¥½æ¼”ç¤ºæˆ‘ä»¬åªè€ƒè™‘æœ€ç®€å•çš„æƒ…å†µï¼Œå¦‚æœçœ‹äº†[vue æºç åˆ†æä¹‹å¦‚ä½•å®ç° observer å’Œ watcher][4]å°±å¾ˆå¥½ç†è§£ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¸‰è¨€ä¸¤è¯­å†è¯´è¯´ï¼Œè¿™æ®µä»£ç è¦å®ç°çš„åŠŸèƒ½å°±æ˜¯å°†
```javascript
    var demo = new Vue({
      el: '#demo',
      data: {
        text: 123,
      },
      render(){
        console.log("æˆ‘è¦renderäº†")
      }
    })
```
 ä¸­`data` é‡Œé¢æ‰€æœ‰çš„å±æ€§ç½®äº observerï¼Œç„¶å`data`é‡Œé¢çš„å±æ€§ï¼Œæ¯”å¦‚ `text` ä»¥æ”¹å˜ï¼Œå°±å¼•èµ·`_update()`å‡½æ•°è°ƒç”¨è¿›è€Œé‡æ–°æ¸²æŸ“ï¼Œæ˜¯æ€æ ·åšåˆ°çš„å‘¢ï¼Œæˆ‘ä»¬çŸ¥é“æ”¹å˜å…¶å®å°±æ˜¯èµ‹å€¼å˜›ï¼Œå½“æˆ‘ç»™`data`ä¸‹é¢çš„`text` èµ‹å€¼çš„æ—¶å€™ `set` å‡½æ•°å°±ä¼šè§¦å‘ï¼Œè¿™ä¸ªæ—¶å€™ è°ƒç”¨ `_update` å°±okäº†ï¼Œä½†æ˜¯
```javascript
     setTimeout(function(){
       demo._data.text = 444
     }, 3000)
```


`demo._data.text`æ²¡æœ‰`demo.text`ç”¨ç€çˆ½ï¼Œæ²¡å…³ç³»ï¼Œæˆ‘ä»¬åŠ ä¸€ä¸ªä»£ç†
```javascript
      _proxy(key) {
        const self = this
        Object.defineProperty(self, key, {
          configurable: true,
          enumerable: true,
          get: function proxyGetter () {
            return self._data[key]
          },
          set: function proxySetter (val) {
            self._data[key] = val
          }
        })
      }
```
ç„¶ååœ¨`Vue`çš„`constructor`åŠ ä¸Šä¸‹é¢è¿™å¥
```javascript
    Object.keys(options.data).forEach(key => this._proxy(key))
```
ç¬¬ä¸€æ­¥å…ˆè¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œ`data`ä¸­ä»»ä½•ä¸€ä¸ªå±æ€§çš„å€¼æ”¹å˜ï¼Œéƒ½ä¼šå¼•èµ·
`_update`çš„è§¦å‘è¿›è€Œé‡æ–°æ¸²æŸ“ï¼Œå±æ€§è¿™æ˜¾ç„¶ä¸å¤Ÿç²¾å‡†å•Š

## ç¬¬äºŒæ­¥ï¼Œè¯¦ç»†é˜è¿°ç¬¬ä¸€æ­¥ä¸ºä»€ä¹ˆä¸å¤Ÿç²¾å‡†
æ¯”å¦‚è€ƒè™‘ä¸‹é¢ä»£ç 
```javascript
    new Vue({
      template: `
        <div>
          <section>
            <span>name:</span> {{name}}
          </section>
          <section>
            <span>age:</span> {{age}}
          </section>
        <div>`,
      data: {
        name: 'js',
        age: 24,
        height: 180
      }
    })

    setTimeout(function(){
      demo.height = 181
    }, 3000)
```
`template`é‡Œé¢åªç”¨åˆ°äº†`data`ä¸Šçš„ä¸¤ä¸ªå±æ€§`name`å’Œ`age`ï¼Œä½†æ˜¯å½“æˆ‘æ”¹å˜`height`çš„æ—¶å€™ï¼Œç”¨ç¬¬ä¸€æ­¥çš„ä»£ç ï¼Œä¼šä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼Ÿä¼šï¼ï¼Œä½†å…¶å®ä¸éœ€è¦è§¦å‘é‡æ–°æ¸²æŸ“ï¼Œè¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ï¼ï¼
##ç¬¬ä¸‰æ­¥ï¼Œä¸Šè¿°é—®é¢˜æ€ä¹ˆè§£å†³
### ç®€å•è¯´è¯´è™šæ‹Ÿ DOM
é¦–å…ˆï¼Œtemplateæœ€åéƒ½æ˜¯ç¼–è¯‘æˆrenderå‡½æ•°çš„(å…·ä½“æ€ä¹ˆåšï¼Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä»¥åæˆ‘ä¼šè¯´çš„)ï¼Œç„¶årender å‡½æ•°æ‰§è¡Œå®Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªè™šæ‹ŸDOMï¼Œä¸ºäº†å¥½ç†è§£æˆ‘ä»¬å†™å†™æœ€ç®€å•çš„è™šæ‹ŸDOM

```javascript
    function VNode(tag, data, children, text) {
      return {
        tag: tag,
        data: data,
        children: children,
        text: text
      }
    }

    class Vue {
      constructor(options) {
        this.$options = options
        const vdom = this._update()
        console.log(vdom)
      }
      _update() {
        return this._render.call(this)
      }
      _render() {
        const vnode = this.$options.render.call(this)
        return vnode
      }
      __h__(tag, attr, children) {
        return VNode(tag, attr, children.map((child)=>{
          if(typeof child === 'string'){
            return VNode(undefined, undefined, undefined, child)
          }else{
            return child
          }
        }))
      }
      __toString__(val) {
        return val == null ? '' : typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val);
      }
    }


    var demo = new Vue({
      el: '#demo',
      data: {
        text: "before",
      },
      render(){
        return this.__h__('div', {}, [
          this.__h__('span', {}, [this.__toString__(this.text)])
        ])
      }
    })
```
æˆ‘ä»¬è¿è¡Œä¸€ä¸‹ï¼Œä»–ä¼šè¾“å‡º
```javascript
     {
       tag: 'div',
       data: {},
       children:[
         {
           tag: 'span',
           data: {},
           children: [
             {
               children: undefined,
               data: undefined,
               tag: undefined,
               text: '' // æ­£å¸¸æƒ…å†µä¸º å­—ç¬¦ä¸² beforeï¼Œå› ä¸ºæˆ‘ä»¬ä¸ºäº†æ¼”ç¤ºå°±ä¸å†™ä»£ç†çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºç©º
             }
           ]
         }
       ]
     }
```
 è¿™å°±æ˜¯ è™šæ‹Ÿæœ€ç®€å•è™šæ‹Ÿ`DOM`,`tag`æ˜¯`html` æ ‡ç­¾åï¼Œ`data` æ˜¯åŒ…å«è¯¸å¦‚ `class` å’Œ `style` è¿™äº›æ ‡ç­¾ä¸Šçš„å±æ€§ï¼Œ`childen`å°±æ˜¯å­èŠ‚ç‚¹ï¼Œå…³äºè™šæ‹ŸDOMå°±ä¸å±•å¼€è¯´äº†ã€‚
å›åˆ°å¼€å§‹çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘å¾—çŸ¥é“ï¼Œ`render` å‡½æ•°é‡Œé¢ä¾èµ–äº†vueå®ä¾‹é‡Œé¢å“ªäº›å˜é‡ï¼ˆåªè€ƒè™‘render å°±å¯ä»¥ï¼Œå› ä¸ºtemplate ä¹Ÿä¼šæ˜¯å¸®ä½ ç¼–è¯‘æˆrenderï¼‰ã€‚å™è¿°æœ‰ç‚¹æ‹—å£ï¼Œè¿˜æ˜¯çœ‹ä»£ç å§
```javascript
    var demo = new Vue({
      el: '#demo',
      data: {
        text: "before",
        name: "123",
        age: 23
      },
      render(){
        return this.__h__('div', {}, [
          this.__h__('span', {}, [this.__toString__(this.text)])
        ])
      }
    })
```
å°±åƒè¿™æ®µä»£ç ï¼Œ`render` å‡½æ•°é‡Œå…¶å®åªä¾èµ–`text`ï¼Œå¹¶æ²¡æœ‰ä¾èµ– `name`å’Œ `age`,æ‰€ä»¥ï¼Œæˆ‘ä»¬åªè¦`text`æ”¹å˜çš„æ—¶å€™
æˆ‘ä»¬è‡ªåŠ¨è§¦å‘ `render` å‡½æ•° è®©å®ƒç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿ`DOM`å°±okäº†ï¼ˆå‰©ä¸‹çš„å°±æ˜¯è¿™ä¸ªè™šæ‹ŸDOMå’Œä¸Šä¸ªè™šæ‹Ÿ`DOM`åšæ¯”å¯¹ï¼Œç„¶åæ“ä½œçœŸå®`DOM`ï¼Œåªèƒ½ä»¥åå†è¯´äº†ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ­£å¼è€ƒè™‘ä¸€ä¸‹æ€ä¹ˆåš
## ç¬¬ä¸‰æ­¥ï¼Œ'touch' æ‹¿åˆ°ä¾èµ–
å›åˆ°æœ€ä¸Šé¢é‚£å¼ å›¾ï¼Œæˆ‘ä»¬çŸ¥é“`data`ä¸Šçš„å±æ€§è®¾ç½®`defineReactive`åï¼Œä¿®æ”¹data ä¸Šçš„å€¼ä¼šè§¦å‘ `set`ã€‚
é‚£ä¹ˆæˆ‘ä»¬å–`data`ä¸Šå€¼æ˜¯ä¼šè§¦å‘ `get`äº†ã€‚
å¯¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šé¢åšåšæ‰‹è„šï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œä¸€ä¸‹`render`ï¼Œæˆ‘ä»¬çœ‹çœ‹`data`ä¸Šå“ªäº›å±æ€§è§¦å‘äº†`get`ï¼Œæˆ‘ä»¬å²‚ä¸æ˜¯å°±å¯ä»¥çŸ¥é“ `render` ä¼šä¾èµ–`data` ä¸Šå“ªäº›å˜é‡äº†ã€‚
ç„¶åæˆ‘ä¹ˆæŠŠè¿™äº›å˜é‡åšäº›æ‰‹è„šï¼Œæ¯æ¬¡è¿™äº›å˜é‡å˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è§¦å‘`render`ã€‚
ä¸Šé¢è¿™äº›æ­¥éª¤ç®€å•ç”¨å››ä¸ªå­æ¦‚æ‹¬å°±æ˜¯ è®¡ç®—ä¾èµ–ã€‚
ï¼ˆå…¶å®ä¸ä»…æ˜¯`render`ï¼Œä»»ä½•ä¸€ä¸ªå˜é‡çš„æ”¹åˆ«ï¼Œæ˜¯å› ä¸ºåˆ«çš„å˜é‡æ”¹å˜å¼•èµ·ï¼Œéƒ½å¯ä»¥ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯`computed` å’Œ `watch` çš„åŸç†ï¼Œä¹Ÿæ˜¯mobxçš„æ ¸å¿ƒï¼‰
###ç¬¬ä¸€æ­¥ï¼Œ
æˆ‘ä»¬å†™ä¸€ä¸ªä¾èµ–æ”¶é›†çš„ç±»ï¼Œæ¯ä¸€ä¸ª`data` ä¸Šçš„å¯¹è±¡éƒ½æœ‰å¯èƒ½è¢«`render`å‡½æ•°ä¾èµ–ï¼Œæ‰€ä»¥æ¯ä¸ªå±æ€§åœ¨`defineReactive`
æ—¶å€™å°±åˆå§‹åŒ–å®ƒï¼Œç®€å•æ¥è¯´å°±æ˜¯è¿™ä¸ªæ ·å­çš„
```javascript
    class Dep {
      constructor() {
        this.subs = []
      }
      add(cb) {
        this.subs.push(cb)
      }
      notify() {
        console.log(this.subs);
        this.subs.forEach((cb) => cb())
      }
    }
    function defineReactive(obj, key, val, cb) {
      const dep = new Dep()
      Object.defineProperty(obj, key, {
        // çœç•¥
      })
    }
```
ç„¶åï¼Œå½“æ‰§è¡Œ`render` å‡½æ•°å»'touch'ä¾èµ–çš„æ—¶å€™ï¼Œä¾èµ–åˆ°çš„å˜é‡getå°±ä¼šè¢«æ‰§è¡Œï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ª `render` å‡½æ•°åŠ åˆ° `subs` é‡Œé¢å»äº†ã€‚
å½“æˆ‘ä»¬ï¼Œ`set` çš„æ—¶å€™ æˆ‘ä»¬å°±æ‰§è¡Œ `notify` å°†æ‰€æœ‰çš„subsæ•°ç»„é‡Œçš„å‡½æ•°æ‰§è¡Œï¼Œå…¶ä¸­å°±åŒ…å«`render` çš„æ‰§è¡Œã€‚
è‡³æ­¤å°±å®Œæˆäº†æ•´ä¸ªå›¾ï¼Œå¥½æˆ‘ä»¬å°†æ‰€æœ‰çš„ä»£ç å±•ç¤ºå‡ºæ¥
```javascript
    function VNode(tag, data, children, text) {
      return {
        tag: tag,
        data: data,
        children: children,
        text: text
      }
    }

    class Vue {
      constructor(options) {
        this.$options = options
        this._data = options.data
        Object.keys(options.data).forEach(key => this._proxy(key))
        observer(options.data)
        const vdom = watch(this, this._render.bind(this), this._update.bind(this))
        console.log(vdom)
      }
      _proxy(key) {
        const self = this
        Object.defineProperty(self, key, {
          configurable: true,
          enumerable: true,
          get: function proxyGetter () {
            return self._data[key]
          },
          set: function proxySetter (val) {
            self._data.text = val
          }
        })
      }
      _update() {
        console.log("æˆ‘éœ€è¦æ›´æ–°");
        const vdom = this._render.call(this)
        console.log(vdom);
      }
      _render() {
        return this.$options.render.call(this)
      }
      __h__(tag, attr, children) {
        return VNode(tag, attr, children.map((child)=>{
          if(typeof child === 'string'){
            return VNode(undefined, undefined, undefined, child)
          }else{
            return child
          }
        }))
      }
      __toString__(val) {
        return val == null ? '' : typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val);
      }
    }

    function observer(value, cb){
      Object.keys(value).forEach((key) => defineReactive(value, key, value[key] , cb))
    }

    function defineReactive(obj, key, val, cb) {
      const dep = new Dep()
      Object.defineProperty(obj, key, {
        enumerable: true,
        configurable: true,
        get: ()=>{
          if(Dep.target){
            dep.add(Dep.target)
          }
          return val
        },
        set: newVal => {
          if(newVal === val)
            return
          val = newVal
          dep.notify()
        }
      })
    }
    function watch(vm, exp, cb){
      Dep.target = cb
      return exp()
    }

    class Dep {
      constructor() {
        this.subs = []
      }
      add(cb) {
        this.subs.push(cb)
      }
      notify() {
        this.subs.forEach((cb) => cb())
      }
    }
    Dep.target = null


    var demo = new Vue({
      el: '#demo',
      data: {
        text: "before",
      },
      render(){
        return this.__h__('div', {}, [
          this.__h__('span', {}, [this.__toString__(this.text)])
        ])
      }
    })


     setTimeout(function(){
       demo.text = "after"
     }, 3000)
```
æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿è¡Œç»“æœ
![D4A9A9B8-03CA-4A73-A12F-30409E08D99D.png][6]

å¥½æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ `Dep.target` å› ä¸ºæˆ‘ä»¬å¾—åŒºåˆ†æ˜¯ï¼Œæ™®é€šçš„`get`ï¼Œè¿˜æ˜¯åœ¨æŸ¥æ‰¾ä¾èµ–çš„æ—¶å€™çš„`get`ï¼Œ
æ‰€æœ‰æˆ‘ä»¬åœ¨æŸ¥æ‰¾ä¾èµ–æ—¶å€™ï¼Œæˆ‘ä»¬å°†
```javascript
    function watch(vm, exp, cb){
      Dep.target = cb
      return exp()
    }
```
`Dep.target` èµ‹å€¼ï¼Œç›¸å½“äº flag ä¸€ä¸‹ï¼Œç„¶å  `get` çš„æ—¶å€™
```javascript
       get: () => {
          if (Dep.target) {
            dep.add(Dep.target)
          }
          return val
        },
```
åˆ¤æ–­ä¸€ä¸‹ï¼Œå°±å¥½äº†ã€‚
åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬å†çœ‹é‚£å¼ å›¾æ˜¯ä¸æ˜¯å°±æ¸…æ¥šå¾ˆå¤šäº†ï¼Ÿ
## æ€»ç»“
  æˆ‘éå¸¸å–œæ¬¢ï¼Œvue2.0 ä»¥ä¸Šä»£ç ä¸ºäº†å¥½å±•ç¤ºï¼Œéƒ½é‡‡ç”¨æœ€ç®€å•çš„æ–¹å¼å‘ˆç°ã€‚
  å¯¹æ¯”reactï¼Œvue2.0 è‡ªåŠ¨å¸®ä½ ç›‘æµ‹ä¾èµ–ï¼Œè‡ªåŠ¨å¸®ä½ é‡æ–°æ¸²æŸ“ï¼Œè€Œ
  react è¦å®ç°æ€§èƒ½æœ€å¤§åŒ–ï¼Œè¦åšå¤§é‡å·¥ä½œï¼Œæ¯”å¦‚æˆ‘ä»¥å‰åˆ†äº«çš„
  [reactå¦‚ä½•æ€§èƒ½è¾¾åˆ°æœ€å¤§åŒ–(å‰ä¼ )ï¼Œæš¨reactä¸ºå•¥éå¾—ä½¿ç”¨immutable.js][7]
  [react å®ç°pure renderçš„æ—¶å€™ï¼Œbind(this)éšæ‚£][8]ã€‚
  è€Œ vue2.0 å¤©ç„¶å¸®ä½ åšåˆ°äº†æœ€ä¼˜,è€Œä¸”å¯¹äºåƒä¸‡å¹´ä¸å˜çš„ å¦‚æ ‡ç­¾ä¸Šé™æ€çš„`class`å±æ€§ï¼Œ
  vue2.0 åœ¨é‡æ–°æ¸²æŸ“ååšdiff çš„æ—¶å€™æ˜¯ä¸æ¯”è¾ƒçš„ï¼Œvue2.0æ¯” è¾¾åˆ°æ€§èƒ½æœ€å¤§åŒ–çš„react è¿˜è¦å¿«çš„ä¸€ä¸ªåŸå› 
  ç„¶åæºç [åœ¨æ­¤][9]ï¼Œå–œæ¬¢çš„è®°å¾—ç»™ä¸ª star å“¦ğŸ˜
  åç»­ï¼Œæˆ‘ä¼šç®€å•èŠèŠï¼Œvue2.0çš„diffã€‚
  å¦‚æœæœ‰ç–‘é—®ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€


  [1]: https://segmentfault.com/a/1190000004384515
  [2]: https://segmentfault.com/a/1190000004346467
  [3]: https://odqs6mk2t.qnssl.com/vuedeptrace.jpg
  [4]: https://segmentfault.com/a/1190000004384515
  [6]: https://odqs6mk2t.qnssl.com/D4A9A9B8-03CA-4A73-A12F-30409E08D99D.png
  [7]: https://segmentfault.com/a/1190000004290333
  [8]: https://segmentfault.com/a/1190000004295639
  [9]: https://github.com/georgebbbb/fakeVue/blob/master/vue2.0/index.js
